import streamlit as st
import akshare as ak
import pandas as pd
import datetime
import time

# Streamlit é é¢é…ç½®ï¼ˆå¯¬å±ã€æ‰‹æ©Ÿå‹å¥½ï¼‰
st.set_page_config(page_title="ä¸­åœ‹Aè‚¡ç†±é–€äººæ°£è‚¡ç›£æ§App", layout="wide")
st.title("ğŸ”¥ ä¸­åœ‹Aè‚¡ç†±é–€äººæ°£å€‹è‚¡ç›£æ§ç³»çµ±")
st.markdown("""
**åŠŸèƒ½èªªæ˜**ï¼š
- å¯¦æ™‚ç›£æ§ç†±é–€äººæ°£è‚¡ç¥¨ï¼ˆé«˜æ›æ‰‹ç‡ + è³‡é‡‘æ´»èºï¼‰
- æª¢æ¸¬é¡¯æ€§ä¸»åŠ›è³‡é‡‘æµå…¥/æµå‡º
- æª¢æ¸¬æ½›åœ¨ã€Œæ‹†å–®/æš—æ± ã€éš±è—è²·å…¥ï¼ˆä¸»åŠ›å¤§å–®æ‹†å°å–®å¸ç±Œï¼‰
- æä¾›ç°¡å–®å…¥å ´/å‡ºå ´æ™‚æ©Ÿæç¤ºï¼ˆåƒ…ä¾›åƒè€ƒï¼ŒåŸºæ–¼è³‡é‡‘æµé‚è¼¯ï¼‰
- æ•¸æ“šä¾†æºï¼šæ±æ–¹è²¡å¯Œ/akshareï¼ˆäº¤æ˜“æ—¥9:30-15:00å¯¦æ™‚ï¼Œéäº¤æ˜“æ—¥æ•¸æ“šéœæ­¢ï¼‰

**è­¦å‘Š**ï¼šæœ¬å·¥å…·åƒ…ä¾›å­¸ç¿’åƒè€ƒï¼ŒéæŠ•è³‡å»ºè­°ï¼è‚¡å¸‚æœ‰é¢¨éšªï¼Œæ‰€æœ‰ä¿¡è™Ÿå‡æœ‰æ»¯å¾Œèˆ‡å™ªéŸ³ï¼Œè«‹çµåˆåŸºæœ¬é¢ã€æŠ€è¡“é¢è‡ªè¡Œåˆ¤æ–·ã€‚
""")

# å´é‚Šæ¬„åƒæ•¸èª¿æ•´
st.sidebar.header("ç›£æ§åƒæ•¸èª¿æ•´ï¼ˆå¯è‡ªè¨‚ï¼‰")
REFRESH_INTERVAL = st.sidebar.slider("è‡ªå‹•åˆ·æ–°é–“éš”ï¼ˆç§’ï¼‰", 60, 600, 300, help="å»ºè­°300ç§’ä»¥ä¸Šï¼Œé¿å…è«‹æ±‚éé »")
HIDDEN_BUY_THRESHOLD = st.sidebar.number_input("æš—æ± è²·å…¥é–¾å€¼ï¼ˆå°å–®æ·¨æµå…¥ï¼Œè¬å…ƒï¼‰", value=5000, help="è¶Šé«˜è¶Šåš´æ ¼")
VISIBLE_SELL_THRESHOLD = st.sidebar.number_input("é¡¯æ€§ä¸»åŠ›æµå‡ºé–¾å€¼ï¼ˆè¬å…ƒï¼‰", value=-2000, help="è² å€¼è¡¨ç¤ºä¸»åŠ›é¡¯æ€§è³£å‡º")
HOT_TURNOVER = st.sidebar.number_input("ç†±é–€äººæ°£æ›æ‰‹ç‡ä¸‹é™ï¼ˆ%ï¼‰", value=5.0, help="æ›æ‰‹ç‡è¶Šé«˜è¶Šç†±é–€")
TOP_N = st.sidebar.slider("é¡¯ç¤ºå‰Nå", 10, 50, 20)

# æ•¸æ“šç²å–å‡½æ•¸
@st.cache_data(ttl=REFRESH_INTERVAL)  # ç·©å­˜æ•¸æ“šï¼Œé¿å…é‡è¤‡è«‹æ±‚
def get_all_data():
    with st.spinner("æ­£åœ¨ä¸‹è¼‰å…¨å¸‚å ´å¯¦æ™‚æ•¸æ“šï¼ˆç´„5000+è‚¡ç¥¨ï¼‰ï¼Œè«‹ç¨ç­‰10-30ç§’..."):
        df = ak.stock_zh_a_spot_em()
        # æ¬„ä½æ¸…ç†
        fund_cols = ['ä¸»åŠ›æ·¨æµå…¥-æ·¨é¡', 'è¶…å¤§å–®æ·¨æµå…¥-æ·¨é¡', 'å¤§å–®æ·¨æµå…¥-æ·¨é¡', 
                     'ä¸­å–®æ·¨æµå…¥-æ·¨é¡', 'å°å–®æ·¨æµå…¥-æ·¨é¡']
        for col in fund_cols:
            if col in df.columns:
                df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)
        
        df['é¡¯æ€§ä¸»åŠ›æ·¨æµå…¥'] = df.get('è¶…å¤§å–®æ·¨æµå…¥-æ·¨é¡', 0) + df.get('å¤§å–®æ·¨æµå…¥-æ·¨é¡', 0)
        df['æ¼²è·Œå¹…'] = pd.to_numeric(df['æ¼²è·Œå¹…'], errors='coerce').fillna(0)
        df['æ›æ‰‹ç‡'] = pd.to_numeric(df['æ›æ‰‹ç‡'], errors='coerce').fillna(0)
        df['ç¸½å¸‚å€¼'] = pd.to_numeric(df['ç¸½å¸‚å€¼'], errors='coerce').fillna(0)
        
        # éæ¿¾ï¼šæ’é™¤STã€é€€å¸‚ã€å°å¸‚å€¼ã€ä½æ´»èº
        df = df[~df['åç¨±'].str.contains('ST|é€€|*', na=False)]
        df = df[df['ç¸½å¸‚å€¼'] > 3e9]  # 30å„„ä»¥ä¸Š
        
        return df

# ä¿¡è™Ÿåˆ¤æ–·å‡½æ•¸
def generate_signal(row):
    visible = row['é¡¯æ€§ä¸»åŠ›æ·¨æµå…¥']
    hidden = row['å°å–®æ·¨æµå…¥-æ·¨é¡']
    turnover = row['æ›æ‰‹ç‡']
    change = row['æ¼²è·Œå¹…']
    
    signals = []
    if visible > 1e7:  # é¡¯æ€§ä¸»åŠ›å¼·æµå…¥ >1å„„
        signals.append("ğŸŸ¢ é¡¯æ€§ä¸»åŠ›å¼·è²·ï¼Œç†±é–€å¸ç±Œ")
    if visible < -5e6 and change < 0:  # ä¸»åŠ›æµå‡º + è‚¡åƒ¹è·Œ
        signals.append("ğŸ”´ ä¸»åŠ›å‡ºè²¨ï¼Œæ³¨æ„å‡ºå ´é¢¨éšª")
    
    if (visible < VISIBLE_SELL_THRESHOLD * 1e4 and 
        hidden > HIDDEN_BUY_THRESHOLD * 1e4 and 
        change >= -1 and turnover > 3):  # æš—æ± æ¢ä»¶
        signals.append("ğŸŸ¡ æ½›åœ¨æš—æ± æ‹†å–®å¼·è²·ï¼Œå¸ç±Œéšæ®µï¼ˆè€ƒæ…®ä½ä½å…¥å ´ï¼‰")
    
    if turnover > HOT_TURNOVER and change > 5:
        signals.append("âš¡ è¶…é«˜äººæ°£ï¼ŒçŸ­æœŸç†±é–€")
    
    if not signals:
        return "âšª ç„¡æ˜é¡¯ä¿¡è™Ÿ"
    return " | ".join(signals)

# ä¸»é‚è¼¯
df = get_all_data()

# ç†±é–€äººæ°£ç¯©é¸ï¼šæ›æ‰‹ç‡é«˜ + æœ‰è³‡é‡‘æ´»èº
hot_df = df[df['æ›æ‰‹ç‡'] > HOT_TURNOVER].copy()

# é¡¯æ€§ä¸»åŠ›ç†±é–€æ¦œ
visible_hot = hot_df[hot_df['é¡¯æ€§ä¸»åŠ›æ·¨æµå…¥'] > 0].sort_values(by='é¡¯æ€§ä¸»åŠ›æ·¨æµå…¥', ascending=False).head(TOP_N)

# æš—æ± æ‹†å–®ç†±é–€æ¦œ
hidden_hot = hot_df[
    (hot_df['é¡¯æ€§ä¸»åŠ›æ·¨æµå…¥'] < VISIBLE_SELL_THRESHOLD * 1e4) &
    (hot_df['å°å–®æ·¨æµå…¥-æ·¨é¡'] > HIDDEN_BUY_THRESHOLD * 1e4) &
    (hot_df['æ¼²è·Œå¹…'] >= -2)
].sort_values(by='å°å–®æ·¨æµå…¥-æ·¨é¡', ascending=False).head(TOP_N)

# æ·»åŠ ä¿¡è™Ÿ
if not visible_hot.empty:
    visible_hot['ä¿¡è™Ÿæç¤º'] = visible_hot.apply(generate_signal, axis=1)
if not hidden_hot.empty:
    hidden_hot['ä¿¡è™Ÿæç¤º'] = hidden_hot.apply(generate_signal, axis=1)

# æ ¼å¼åŒ–é‡‘é¡ï¼ˆå„„å…ƒï¼‰
def format_money(df):
    money_cols = ['é¡¯æ€§ä¸»åŠ›æ·¨æµå…¥', 'å°å–®æ·¨æµå…¥-æ·¨é¡', 'ä¸»åŠ›æ·¨æµå…¥-æ·¨é¡', 'ç¸½å¸‚å€¼']
    for col in money_cols:
        å¦‚æœå±±å£åœ¨ df.columns:
            df[f'{col}ï¼ˆå„„å…ƒï¼‰'] = (df[col] /1e8).round(2)
è¿”å›df

# é¡¯ç¤ºçµæœ
col1, col2 = st.columns(2)

ä¸1ï¼š
    st.subheader(f"ç†±é–€é¡¯æ€§ä¸»åŠ›æµå…¥æ¦œï¼ˆbiocom{TOP_N}ï¼‰)
    å¦‚æœ visible_hot.empty:
        st.info("ç•¶å‰ç„¡ç¬¦åˆæ¢ä»¶çš„ç†±é–€é¡¯æ€§ä¸»åŠ›æµå…¥è‚¡ç¥¨")
    å…¶ä»–çš„:
display_cols = ['ä»£ç¢¼', 'åç¨±', 'æœ€æ–°åƒ¹', 'æ¼²è·Œå¹…', 'æ›æ‰‹ç‡', 
                        'é¡¯æ€§ä¸»åŠ›æ·¨æµå…¥(å„„å…ƒ)', 'å°å–®æ·¨æµå…¥-æ·¨é¡(å„„å…ƒ)', 'ç¸½å¸‚å€¼(å„„å…ƒ)', 'ä¿¡è™Ÿæç¤º']
display_cols = [cä¸ºCåœ¨ display_cols å¦‚æœCåœ¨ format_money(visible_hot).columns]
st.dataframe(format_money(visible_hot)[display_cols], use_container_width=True)

ä¸co2ï¼š
    st.subheader(f"ï¸ç†±é–€æ½›åœ¨æš—æ± /ä½ æ€ä¹ˆçœ‹ï¼ˆ{TOP_N}ï¼‰)
å¦‚æœ hidden_hot.emptyï¼š
        st.info("ç•¶å‰ç„¡ç¬¦åˆæ¢ä»¶çš„ç†±é–€æš—æ± è²·å…¥è‚¡ç¥¨")
å…¶ä»–çš„:
display_cols = ['ä»£ç¢¼', 'åç¨±', 'æœ€æ–°åƒ¹', 'æ¼²è·Œå¹…', 'æ›æ‰‹ç‡', 
                        'é¡¯æ€§ä¸»åŠ›æ·¨æµå…¥(å„„å…ƒ)', 'å°å–®æ·¨æµå…¥-æ·¨é¡(å„„å…ƒ)', 'ä¼°è¨ˆæš—æ± æµå…¥(å„„å…ƒ)', 'ç¸½å¸‚å€¼(å„„å…ƒ)', 'ä¿¡è™Ÿæç¤º']
        hidden_hot['ä¼°è¨ˆæš—æ± æµå…¥(å„„å…ƒ)'] = (hidden_hot['å°å–®æ·¨æµå…¥-æ·¨é¡'] /1e8).round(2)
display_cols=[Cä¸º C display_cols you made_money(hidden_hot)
        st.dataframe(format_money(hidden_hot)[display_cols], use_container_width=True)

# å€‹è‚¡æŸ¥è©¢åŠŸèƒ½
st.sidebar.header("å€‹è‚¡è³‡é‡‘æŸ¥è©¢")
stock_code = st.sidebar.text_input("è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¦‚600519ï¼‰æˆ–åç¨±é—œéµå­—")
å¦‚æœ stock_code:
search_df = df[df['ä»£ç¢¼'].str.contains(stock_code) | df['åç¨±'].str.contains(stock_code)]
å¦‚æœ not search_df
        st.subheader(f"å€‹è‚¡è³‡é‡‘è©³æƒ…ï¼š{search_df.iloc[0]['mayoto']}ï¼ˆ{search_df.iloc[0]['brioto']}ï¼‰
        row = search_df.iloc[0]
st.dataframe(format_money(hidden_hot)[display_cols], use_container_width=True)
# å€‹è‚¡æŸ¥è©¢åŠŸèƒ½
st.sidebar.headerï¼ˆ[å€‹è‚¡è³‡é‡‘æŸ¥è©¢]ï¼‰
stock_code=st. sidebar. text_inputï¼ˆ"è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆ600519ï¼‰you joryou willoyouï¼‰
å…¶ä»–çš„:
å¦‚æœè‚¡ç¥¨_youï¼š

search_df=df[df['ä»£ç¢¼'].str.containsï¼ˆstock_codeï¼‰|df['''str.containsï¼ˆstock_codeï¼‰]
å¦‚æœä¸æ˜¯ search_df.emptyï¼š
st.å­æ ‡é¢˜ï¼ˆf"you weboto:{search_df. iloc[0]'ï¼‰ï¼‰ï¼‰'mayoto']}ï¼ˆ{search_df. iloc[0]']}ï¼‰"
    st.rerun()

row = search_df.iloc[0]
st.markdown("---")
st. write fæœ€æ–°åƒ¹ï¼š{##''}ï¼…|{è¡Œ[''']}ï¼…"ï¼‰
st.code("""
st.writeé¡¯æ€§ä¸»åŠ›æ·¨æµå…¥ï¼š{[mayou you]/18ï¼šï¼‰
st.writeï¼ˆf"å°å–®æ·¨æµå…¥ yousyou mayoto mayouï¼‰ï¼š{row.getï¼ˆ''''''youmoviowemoto-'1,0ï¼‰

st.writeï¼ˆf"**ä¿¡è™Ÿæç¤º**ï¼š{generate_signalï¼ˆrowï¼‰}"ï¼‰

é”™è¯¯ï¼ˆ[****]ï¼‰
# è‡ªå‹•åˆ·æ–°æç¤º

æ ‡è®°"æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š{datetime.datetime.nowï¼ˆï¼‰
""")
st.markdown(å¦‚æœåœ£ä¾§è¾¹æ )
